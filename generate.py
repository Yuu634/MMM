import tensorflow as tf
from transformers import GPT2LMHeadModel
from transformers import PreTrainedTokenizerFast
from tokenizers import Tokenizer
import os
import numpy as np
from source.helpers.samplinghelpers import *
from itertools import takewhile
import sys
import music21
from fractions import Fraction
import torch
import re

#datapath = "ver1"
# Where the checkpoint lives.
# Note can be downloaded from: https://ai-guru.s3.eu-central-1.amazonaws.com/mmm-jsb/mmm_jsb_checkpoints.zip
#check_point_path = os.path.join("checkpoints", "20210411-1426")

#print("Reconstructed sample")
#render_token_sequence(generated_sample, use_program=False)


#楽曲全体の作成 per_bar:1度の小節生成数
def generate_song(data_path,model_name,per_bar):
    """モデル準備"""
    validation_data_path = os.path.join("datasets", data_path, model_name, "token_sequences_valid.txt")

    #Load tokenizer
    tokenizer_path = os.path.join("datasets", data_path, model_name, "tokenizer.json")
    tokenizer = Tokenizer.from_file(tokenizer_path)
    tokenizer = PreTrainedTokenizerFast(tokenizer_file=tokenizer_path)
    tokenizer.add_special_tokens({'pad_token': '[PAD]'})
    
    #Load model
    model_path = os.path.join("training", data_path, model_name, "best_model")
    #model_path = os.path.join("training", data_path, "checkpoint-245000")
    model = GPT2LMHeadModel.from_pretrained(model_path)
    
    """条件生成"""
    print("Model loaded.")
    priming_sample, priming_sample_original = get_priming_token_sequence(
        validation_data_path,
        stop_on_track_end=0,
        stop_after_n_tokens=20,
        return_original=True
    )
    priming_sample = "Atmosphere=0 Atmosphere=31 BarCount=2 Atmosphere=31 TRACK_START INST=0 DENSITY=4 BAR_START NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=49 TIME_DELTA=1.0 NOTE_OFF=49 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=58 TIME_DELTA=1.0 NOTE_OFF=58 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=49 TIME_DELTA=1.0 NOTE_OFF=49 TIME_DELTA=1.0 NOTE_ON=59 TIME_DELTA=1.0 NOTE_OFF=59 NOTE_ON=55 TIME_DELTA=1.0 NOTE_OFF=55 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 BAR_END BAR_START NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=49 TIME_DELTA=1.0 NOTE_OFF=49 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=58 TIME_DELTA=1.0 NOTE_OFF=58 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=49 TIME_DELTA=1.0 NOTE_OFF=49 TIME_DELTA=1.0 NOTE_ON=59 TIME_DELTA=1.0 NOTE_OFF=59 NOTE_ON=55 TIME_DELTA=1.0 NOTE_OFF=55 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 BAR_END TRACK_END TRACK_START INST=1 DENSITY=1 BAR_START TIME_DELTA=2.0 NOTE_ON=77 TIME_DELTA=1.0 NOTE_OFF=77 TIME_DELTA=1.0 NOTE_ON=73 TIME_DELTA=8.0 NOTE_OFF=73 NOTE_ON=75 TIME_DELTA=2.0 NOTE_OFF=75 NOTE_ON=73 TIME_DELTA=1.0 NOTE_OFF=73 NOTE_ON=80 TIME_DELTA=1.0 NOTE_OFF=80 BAR_END BAR_START NOTE_ON=79 TIME_DELTA=16.0 NOTE_OFF=79 BAR_END TRACK_END TRACK_START INST=2 DENSITY=0 BAR_START NOTE_ON=63 TIME_DELTA=1.0 NOTE_OFF=63 TIME_DELTA=1.0 NOTE_ON=73 TIME_DELTA=1.0 NOTE_OFF=73 TIME_DELTA=2.0 NOTE_ON=70 TIME_DELTA=7.0 NOTE_OFF=70 NOTE_ON=61 TIME_DELTA=4.0 NOTE_OFF=61 BAR_END BAR_START NOTE_ON=63 TIME_DELTA=16.0 NOTE_OFF=63 BAR_END TRACK_END TRACK_START INST=3 DENSITY=0 BAR_START BAR_END BAR_START BAR_END TRACK_END BarCount=3 Atmosphere=31 TRACK_START INST=0 DENSITY=4 BAR_START NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=49 TIME_DELTA=1.0 NOTE_OFF=49 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=58 TIME_DELTA=1.0 NOTE_OFF=58 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=49 TIME_DELTA=1.0 NOTE_OFF=49 TIME_DELTA=1.0 NOTE_ON=59 TIME_DELTA=1.0 NOTE_OFF=59 NOTE_ON=55 TIME_DELTA=1.0 NOTE_OFF=55 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 BAR_END BAR_START NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=49 TIME_DELTA=1.0 NOTE_OFF=49 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=58 TIME_DELTA=1.0 NOTE_OFF=58 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=49 TIME_DELTA=1.0 NOTE_OFF=49 TIME_DELTA=1.0 NOTE_ON=59 TIME_DELTA=1.0 NOTE_OFF=59 NOTE_ON=55 TIME_DELTA=1.0 NOTE_OFF=55 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 BAR_END TRACK_END TRACK_START INST=1 DENSITY=1 BAR_START TIME_DELTA=2.0 NOTE_ON=77 TIME_DELTA=1.0 NOTE_OFF=77 TIME_DELTA=1.0 NOTE_ON=73 TIME_DELTA=8.0 NOTE_OFF=73 NOTE_ON=75 TIME_DELTA=2.0 NOTE_OFF=75 NOTE_ON=73 TIME_DELTA=1.0 NOTE_OFF=73 NOTE_ON=75 TIME_DELTA=1.0 NOTE_OFF=75 BAR_END BAR_START NOTE_ON=73 TIME_DELTA=1.0 NOTE_OFF=73 TIME_DELTA=3.0 NOTE_ON=70 TIME_DELTA=12.0 NOTE_OFF=70 BAR_END TRACK_END TRACK_START INST=2 DENSITY=1 BAR_START TIME_DELTA=2.0 NOTE_ON=73 TIME_DELTA=1.0 NOTE_OFF=73 TIME_DELTA=2.0 NOTE_ON=70 TIME_DELTA=7.0 NOTE_OFF=70 NOTE_ON=68 TIME_DELTA=4.0 NOTE_OFF=68 BAR_END BAR_START NOTE_ON=67 TIME_DELTA=12.0 NOTE_OFF=67 NOTE_ON=65 TIME_DELTA=2.0 NOTE_OFF=65 NOTE_ON=67 TIME_DELTA=1.0 NOTE_OFF=67 NOTE_ON=65 TIME_DELTA=1.0 NOTE_OFF=65 BAR_END TRACK_END TRACK_START INST=3 DENSITY=0 BAR_START BAR_END BAR_START BAR_END TRACK_END" #BarCount=4 Atmosphere=31 Atmosphere=0 TRACK_START INST=0 DENSITY=4 BAR_START NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=49 TIME_DELTA=1.0 NOTE_OFF=49 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=58 TIME_DELTA=1.0 NOTE_OFF=58 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=49 TIME_DELTA=1.0 NOTE_OFF=49 TIME_DELTA=1.0 NOTE_ON=59 TIME_DELTA=1.0 NOTE_OFF=59 NOTE_ON=55 TIME_DELTA=1.0 NOTE_OFF=55 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 BAR_END BAR_START NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=49 TIME_DELTA=1.0 NOTE_OFF=49 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=58 TIME_DELTA=1.0 NOTE_OFF=58 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 TIME_DELTA=1.0 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 NOTE_ON=49 TIME_DELTA=1.0 NOTE_OFF=49 TIME_DELTA=1.0 NOTE_ON=59 TIME_DELTA=1.0 NOTE_OFF=59 NOTE_ON=55 TIME_DELTA=1.0 NOTE_OFF=55 NOTE_ON=51 TIME_DELTA=1.0 NOTE_OFF=51 BAR_END TRACK_END TRACK_START INST=1 DENSITY=1 BAR_START TIME_DELTA=2.0 NOTE_ON=77 TIME_DELTA=1.0 NOTE_OFF=77 TIME_DELTA=1.0 NOTE_ON=73 TIME_DELTA=8.0 NOTE_OFF=73 NOTE_ON=75 TIME_DELTA=2.0 NOTE_OFF=75 NOTE_ON=73 TIME_DELTA=1.0 NOTE_OFF=73 NOTE_ON=80 TIME_DELTA=1.0 NOTE_OFF=80 BAR_END BAR_START NOTE_ON=79 TIME_DELTA=16.0 NOTE_OFF=79 BAR_END TRACK_END TRACK_START INST=2 DENSITY=1 BAR_START NOTE_ON=63 TIME_DELTA=1.0 NOTE_OFF=63 TIME_DELTA=1.0 NOTE_ON=73 TIME_DELTA=1.0 NOTE_OFF=73 TIME_DELTA=1.0 NOTE_ON=70 TIME_DELTA=1.0 NOTE_OFF=70 NOTE_ON=70 TIME_DELTA=7.0 NOTE_OFF=70 TIME_DELTA=2.0 NOTE_ON=61 TIME_DELTA=2.0 NOTE_OFF=61 BAR_END BAR_START NOTE_ON=63 TIME_DELTA=16.0 NOTE_OFF=63 BAR_END TRACK_END TRACK_START INST=3 DENSITY=0 BAR_START BAR_END BAR_START BAR_END TRACK_END BarCount=5 Atmosphere=0 TRACK_START INST=0 DENSITY=4 BAR_START NOTE_ON=50 TIME_DELTA=1.0 NOTE_OFF=50 TIME_DELTA=1.0 NOTE_ON=50 TIME_DELTA=1.0 NOTE_OFF=50 NOTE_ON=48 TIME_DELTA=1.0 NOTE_OFF=48 TIME_DELTA=1.0 NOTE_ON=58 TIME_DELTA=1.0 NOTE_OFF=58 NOTE_ON=54 TIME_DELTA=1.0 NOTE_OFF=54 NOTE_ON=50 TIME_DELTA=1.0 NOTE_OFF=50 NOTE_ON=50 TIME_DELTA=1.0 NOTE_OFF=50 TIME_DELTA=1.0 NOTE_ON=50 TIME_DELTA=1.0 NOTE_OFF=50 NOTE_ON=48 TIME_DELTA=1.0 NOTE_OFF=48 TIME_DELTA=1.0 NOTE_ON=58 TIME_DELTA=1.0 NOTE_OFF=58 NOTE_ON=54 TIME_DELTA=1.0 NOTE_OFF=54 NOTE_ON=50 TIME_DELTA=1.0 NOTE_OFF=50 BAR_END BAR_START NOTE_ON=50 TIME_DELTA=1.0 NOTE_OFF=50 TIME_DELTA=1.0 NOTE_ON=50 TIME_DELTA=1.0 NOTE_OFF=50 NOTE_ON=48 TIME_DELTA=1.0 NOTE_OFF=48 TIME_DELTA=1.0 NOTE_ON=58 TIME_DELTA=1.0 NOTE_OFF=58 NOTE_ON=54 TIME_DELTA=1.0 NOTE_OFF=54 NOTE_ON=50 TIME_DELTA=1.0 NOTE_OFF=50 NOTE_ON=50 TIME_DELTA=1.0 NOTE_OFF=50 TIME_DELTA=1.0 NOTE_ON=50 TIME_DELTA=1.0 NOTE_OFF=50 NOTE_ON=48 TIME_DELTA=1.0 NOTE_OFF=48 TIME_DELTA=1.0 NOTE_ON=58 TIME_DELTA=1.0 NOTE_OFF=58 NOTE_ON=54 TIME_DELTA=1.0 NOTE_OFF=54 NOTE_ON=50 TIME_DELTA=1.0 NOTE_OFF=50 BAR_END TRACK_END TRACK_START INST=1 DENSITY=4 BAR_START TIME_DELTA=2.0 NOTE_ON=66 TIME_DELTA=1.0 NOTE_OFF=66 TIME_DELTA=1.0 NOTE_ON=66 TIME_DELTA=3.0 NOTE_OFF=66 NOTE_ON=78 TIME_DELTA=1.0 NOTE_OFF=78 NOTE_ON=66 TIME_DELTA=1.0 NOTE_OFF=66 NOTE_ON=78 TIME_DELTA=1.0 NOTE_OFF=78 NOTE_ON=66 TIME_DELTA=1.0 NOTE_OFF=66 NOTE_ON=78 TIME_DELTA=1.0 NOTE_OFF=78 NOTE_ON=66 TIME_DELTA=1.0 NOTE_OFF=66 NOTE_ON=78 TIME_DELTA=1.0 NOTE_OFF=78 NOTE_ON=66 TIME_DELTA=1.0 NOTE_OFF=66 NOTE_ON=78 TIME_DELTA=1.0 NOTE_OFF=78 BAR_END BAR_START TIME_DELTA=2.0 NOTE_ON=68 TIME_DELTA=1.0 NOTE_OFF=68 TIME_DELTA=1.0 NOTE_ON=68 TIME_DELTA=3.0 NOTE_OFF=68 NOTE_ON=80 TIME_DELTA=1.0 NOTE_OFF=80 NOTE_ON=68 TIME_DELTA=1.0 NOTE_OFF=68 NOTE_ON=80 TIME_DELTA=1.0 NOTE_OFF=80 NOTE_ON=68 TIME_DELTA=1.0 NOTE_OFF=68 NOTE_ON=80 TIME_DELTA=1.0 NOTE_OFF=80 NOTE_ON=68 TIME_DELTA=1.0 NOTE_OFF=68 NOTE_ON=80 TIME_DELTA=1.0 NOTE_OFF=80 NOTE_ON=68 TIME_DELTA=1.0 NOTE_OFF=68 NOTE_ON=80 TIME_DELTA=1.0 NOTE_OFF=80 BAR_END TRACK_END TRACK_START INST=2 DENSITY=4 BAR_START TIME_DELTA=2.0 NOTE_ON=62 TIME_DELTA=1.0 NOTE_OFF=62 TIME_DELTA=1.0 NOTE_ON=62 TIME_DELTA=3.0 NOTE_OFF=62 NOTE_ON=74 TIME_DELTA=1.0 NOTE_OFF=74 NOTE_ON=62 TIME_DELTA=1.0 NOTE_OFF=62 NOTE_ON=74 TIME_DELTA=1.0 NOTE_OFF=74 NOTE_ON=62 TIME_DELTA=1.0 NOTE_OFF=62 NOTE_ON=74 TIME_DELTA=1.0 NOTE_OFF=74 NOTE_ON=62 TIME_DELTA=1.0 NOTE_OFF=62 NOTE_ON=74 TIME_DELTA=1.0 NOTE_OFF=74 NOTE_ON=62 TIME_DELTA=1.0 NOTE_OFF=62 NOTE_ON=74 TIME_DELTA=1.0 NOTE_OFF=74 BAR_END BAR_START TIME_DELTA=2.0 NOTE_ON=64 TIME_DELTA=1.0 NOTE_OFF=64 TIME_DELTA=1.0 NOTE_ON=64 TIME_DELTA=3.0 NOTE_OFF=64 NOTE_ON=76 TIME_DELTA=1.0 NOTE_OFF=76 NOTE_ON=64 TIME_DELTA=1.0 NOTE_OFF=64 NOTE_ON=76 TIME_DELTA=1.0 NOTE_OFF=76 NOTE_ON=64 TIME_DELTA=1.0 NOTE_OFF=64 NOTE_ON=76 TIME_DELTA=1.0 NOTE_OFF=76 NOTE_ON=64 TIME_DELTA=1.0 NOTE_OFF=64 NOTE_ON=76 TIME_DELTA=1.0 NOTE_OFF=76 NOTE_ON=64 TIME_DELTA=1.0 NOTE_OFF=64 NOTE_ON=76 TIME_DELTA=1.0 NOTE_OFF=76 BAR_END TRACK_END TRACK_START INST=3 DENSITY=0 BAR_START BAR_END BAR_START BAR_END TRACK_END"
    #最初の2*per_bar小節生成
    generated_sample = generate(model, tokenizer, priming_sample)
    print(priming_sample)
    print(generated_sample)
    #sys.exit()
    song_sequences = generated_sample.split("[PAD]")[0]
    Atmosphere_list = []
    barstart_idx = list(re.finditer("BarCount", generated_sample))[per_bar]
    Atmosphere_list.extend(re.findall(r'\bAtmosphere=\d+',generated_sample[:barstart_idx.start()]))
    print(generated_sample.split("[PAD]")[0])
    
    #per_bar小節ずつ生成
    k=0
    while True:
        #生成条件
        generate_bar = "BarCount" + generated_sample.split("BarCount",per_bar+1)[per_bar+1].split("[PAD]")[0]
        Atmosphere_list.extend(re.findall(r'\bAtmosphere=\d+',generate_bar))
        for i in range(len(Atmosphere_list) - 1, 0, -1):
            if Atmosphere_list[i] == Atmosphere_list[i - 1]:
                del Atmosphere_list[i]
        priming_sample = " ".join(Atmosphere_list) + " " + generate_bar 
        
        #次の小節作成
        print(priming_sample)
        generated_sample = generate(model, tokenizer, priming_sample)
        song_sequences += "BarCount" + generated_sample.split("BarCount",per_bar+1)[per_bar+1].split("[PAD]")[0]
        #print("BarCount" + generated_sample.split("BarCount",per_bar+1)[per_bar+1].split("[PAD]")[0])
        #楽曲終了時
        print(k)
        k += 1
        if k > 5:
            break
        if "PIECE_END" in generated_sample:
            break
    
    print("Reconstructed sample")
    render_token_sequence(song_sequences, use_program=False)
    return song_sequences

generate_song("4bar_AtmosphereAll2", "", 2)
